---
# Run this file first, it will add the calling user to sudoers with no password and 
# transfer SSH keys for password-free logins to the remote machine. 
# 
# It needs to be run with a sudo password provided:
#   $ ansible-playbook bootstrap.yml --extra-vars "target=imac-1.local" -K

- hosts: '{{ target }}'
  user: iop
  sudo: yes


  tasks: 
    - name: Authorized key to remote
      authorized_key: user={{ ansible_ssh_user }} key="{{ lookup('file', '~/.ssh/id_dsa.pub') }}"

    - name: Add {{ ansible_ssh_user }} to sudoers with no password
      lineinfile: 'dest=/etc/sudoers state=present regexp="^{{ ansible_ssh_user }}\s+ALL=\(ALL\) NOPASSWD: ALL" insertbefore="^#\s+Samples"  line="{{ ansible_ssh_user }}  ALL=(ALL) NOPASSWD: ALL" backup=yes'

